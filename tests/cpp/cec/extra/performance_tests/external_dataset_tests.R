source('common.R')
library(mclust)
library(nlme)
library(gmum.r)
library(CEC)

data_path <- '../../../../../inst/data_sets/cec'
plots_path <- file.path('.', 'plots')
gmum_plot_path <- file.path(plots_path, 'gmum')
cran_plot_path <- file.path(plots_path, 'cran')
dir.create(gmum_plot_path, showWarnings = FALSE, recursive = TRUE)
dir.create(cran_plot_path, showWarnings = FALSE, recursive = TRUE)
test_data = list()

#test_data[['DimSet']] = list(
#    DimSets_32 = load_dataset(data_path = file.path(data_path, "DimSets_32")),
#    DimSets_64 = load_dataset(data_path = file.path(data_path, "DimSets_64")),
#    DimSets_128 = load_dataset(data_path = file.path(data_path, "DimSets_128")),
#    DimSets_256 = load_dataset(data_path = file.path(data_path, "DimSets_256")),
#    DimSets_512 = load_dataset(data_path = file.path(data_path, "DimSets_512"))
#    DimSets_1024 = load_dataset(data_path = file.path(data_path, "DimSets_1024"))
#)

test_data[['UCI']] = list(
    iris = load_dataset(data_path = file.path(data_path, "UCI","iris")),
    glass = load_dataset(data_path = file.path(data_path, "UCI", "glass")),
    vowel = load_dataset(data_path = file.path(data_path, "UCI", "vowel")),
    wine = load_dataset(data_path = file.path(data_path, "UCI", "wine")),
    pendigits = load_dataset(data_path = file.path(data_path, "UCI", "pendigits")),
    poker = load_dataset(data_path = file.path(data_path, "UCI", "poker")),
    connect_4 = load_dataset(data_path = file.path(data_path, "UCI", "connect_4"))
    #covtype = load_dataset(data_path = file.path(data_path, "UCI", "covtype"))
)

gmum_cec_uci <- function(method_type, points, nclusters, output_plot_path = NULL) {
    return (gmum_cec(nstart = 1000, init_type = 'kmeans++', max_iterations = 200, method_type = method_type, points = points, nclusters = nclusters, eps = 0.01, output_plot_path))     
}

cran_cec_uci <- function(method_type, points, nclusters, output_plot_path = NULL) {
    return (cran_cec(nstart = 1000, init_type = 'kmeans++', max_iterations = 200, method_type = method_type, points = points, nclusters = nclusters, eps = "1%", output_plot_path))
}

for(name in names(test_data)) {    
    for(i in 1:length(test_data[[name]])) {
        item = test_data[[name]][[i]]        
        dataset = item$dataset
        dataset_dim = dim(dataset)

        cat(paste(name, '/', item$name, '(k=',item$k,', rows=', dataset_dim[1], ', cols=', dataset_dim[2], ')\n'))
        for(j in 1:nmethod_types) {
            plot_file_name <- paste(c(name, item$name, method_types$gmum[j], '.jpg'), collapse='_')
            
            gmum <- tryCatch({
                gmum_result <- gmum_cec_uci(method_type = method_types$gmum[j], points = dataset, nclusters = item$k)
                gmum_clustering_df <- data.frame(gmum_result$clustering, item$clustering)
                colnames(gmum_clustering_df) <- c('gmum', 'correct')
                gmum_rand_index <- adjustedRandIndex(gmum_result$clustering, item$clustering)
                gmum_bic <- BIC(lm(gmum ~ correct, data=gmum_clustering_df))
                list(
                    energy = gmum_result$energy,
                    iters = gmum_result$iters,
                    time = gmum_result$time,
                    final_nclusters = gmum_result$final_nclusters,
                    rand_index = gmum_rand_index,
                    bic = gmum_bic
                )
            }, error = function(e) {
                cat(paste('gmum: error occured: ', e))
                return(list(
                energy = 'failed',
                iters = 'failed',
                time = 'failed',
                final_nclusters = 'failed',
                rand_index = 'failed',
                bic = 'failed'))     
            })            
            
            cran <- tryCatch({
                cran_result <- cran_cec_uci(method_type = method_types$cran[j], points = dataset, nclusters = item$k)
                cran_clustering_df <- data.frame(cran_result$clustering, item$clustering)
                colnames(cran_clustering_df) <- c('cran', 'correct')
                cran_rand_index <- adjustedRandIndex(cran_result$clustering, item$clustering)           
                cran_bic <- BIC(lm(cran ~ correct, data=cran_clustering_df))            
                list(
                    energy = cran_result$energy,
                    iters = cran_result$iters,
                    time = cran_result$time,
                    final_nclusters = cran_result$final_nclusters,
                    rand_index = cran_rand_index,
                    bic = cran_bic
                )
            }, error = function(e) {
                cat(paste('cran: error occured: ', e))               
                return(list(
                    energy = 'failed',
                    iters = 'failed',
                    time = 'failed',
                    final_nclusters = 'failed',
                    rand_index = 'failed',
                    bic = 'failed'))     
            })
            
            table_data <- matrix(
                c(gmum$energy, cran$energy,
                  gmum$iters, cran$iters,
                  gmum$time, cran$time,
                  gmum$final_nclusters, cran$final_nclusters,
                  gmum$rand_index, cran$rand_index,
                  gmum$bic, cran$bic),
                ncol=2, 
                byrow=TRUE
            )
            
            cat('method type: ', method_types$gmum[j], '\n')
            table_data <- as.table(table_data)
            colnames(table_data) <- c('gmum', 'cran')
            rownames(table_data) <- c('energy', 'iters', 'time', 'clusters', 'rand index', 'BIC')            
            print(table_data)
            cat('\n')
        }
    }
}
